# CapStore API

## EntityFramework Core 7.0.14

<https://learn.microsoft.com/ja-jp/ef/ef6/modeling/code-first/migrations/>
<https://qiita.com/hiro-hiro/items/41ddd4c1589c961f22b0>

1. 事前準備
ターミナルで以下を実行

```bash
dotnet tool install --global dotnet-ef --version 7.0.14
```

2. プロジェクト`cap-store-api`
以下をインストール

- `Microsoft.EntityFrameworkCore.Design`

3. 初回マイグレーション

ターミナルで以下を実行するとエラーが出た

```bash
dotnet ef migrations add init
```

エラー内容

```bash
Build succeeded.
Your target project 'CapStoreAPI' doesn't match your migrations assembly 'CapStore.Infrastructure.Ef'. Either change your target project or change your migrations assembly.
Change your migrations assembly by using DbContextOptionsBuilder. E.g. options.UseSqlServer(connection, b => b.MigrationsAssembly("CapStoreAPI")). By default, the migrations assembly is the assembly containing the DbContext.
Change your target project to the migrations project by using the Package Manager Console's Default project drop-down list, or by executing "dotnet ef" from the directory containing the migrations project.
```

Program.csを修正

```c#:Program.cs
using Akizuki.Domain.Catalogs;
using Akizuki.Infrastructure.Catalogs.Html;
using CapStore.Domain.Categories;
using CapStore.Domain.Makers;
using CapStore.Infrastructure.Ef;
using CapStore.Infrastructure.Ef.Categories;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");

//DB setting
builder.Services.AddDbContext<CapStoreDbContext>((_, options) =>
{
    //options.UseNpgsql(connectionString);
    //以下に書き換えないとコマンドが実行できない
    options.UseNpgsql(connectionString, b => b.MigrationsAssembly("CapStoreAPI"));
});


//DI
builder.Services.AddTransient<ICategoryRepository, EfCategoryRepository>();
builder.Services.AddTransient<IMakerRepository, EfMakerRepository>();
builder.Services.AddTransient<IAzikzukiPageRepository, AkizukiPageHtmlRepository>();

builder.Services.AddControllers();

var app = builder.Build();

// Configure the HTTP request pipeline.

app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.Run();
```

ターミナルで以下を再試行

```bash
dotnet ef migrations add init
```

成功結果

```bash
Build succeeded.
Done. To undo this action, use 'ef migrations remove'
```

4. マイグレーション反映
ターミナルで以下のコマンドを実行

```bash
dotnet ef database update
```

結果

```bash
Build started...
Build succeeded.
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (14ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT EXISTS (
          SELECT 1 FROM pg_catalog.pg_class c
          JOIN pg_catalog.pg_namespace n ON n.oid=c.relnamespace
          WHERE n.nspname='public' AND
                c.relname='__EFMigrationsHistory'
      )
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (12ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE "__EFMigrationsHistory" (
          "MigrationId" character varying(150) NOT NULL,
          "ProductVersion" character varying(32) NOT NULL,
          CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
      );
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT EXISTS (
          SELECT 1 FROM pg_catalog.pg_class c
          JOIN pg_catalog.pg_namespace n ON n.oid=c.relnamespace
          WHERE n.nspname='public' AND
                c.relname='__EFMigrationsHistory'
      )
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT "MigrationId", "ProductVersion"
      FROM "__EFMigrationsHistory"
      ORDER BY "MigrationId";
info: Microsoft.EntityFrameworkCore.Migrations[20402]
      Applying migration '20231128142925_init'.
Applying migration '20231128142925_init'.
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (7ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE categories (
          id integer GENERATED BY DEFAULT AS IDENTITY,
          name text NOT NULL,
          image_url text NULL,
          CONSTRAINT "PK_categories" PRIMARY KEY (id)
      );
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (2ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE makers (
          id integer GENERATED BY DEFAULT AS IDENTITY,
          name text NOT NULL,
          image_url text NULL,
          CONSTRAINT "PK_makers" PRIMARY KEY (id)
      );
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE INDEX "IX_categories_name" ON categories (name);
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE INDEX "IX_makers_name" ON makers (name);
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
      VALUES ('20231128142925_init', '7.0.14');
Done.
```

5. DB確認
`docker-compose.yaml`の内容で実行した場合、以下のURLでpgadminにアクセスし、内容を確認する

<http://localhost:8080/login?next=%2F>
